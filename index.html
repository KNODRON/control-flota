<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salida OS9</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF CDN -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    .message-box {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
      visibility: hidden;
    }
    .message-box.active { visibility: visible; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="container mx-auto max-w-2xl bg-white rounded-lg shadow-lg p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold text-gray-800">Salida OS9</h1>
      <img src="logo_os9.png" alt="Logo OS9" class="h-10">
    </header>

    <!-- Message Box -->
    <div id="messageBox" class="message-box">
      <div class="bg-white p-6 rounded-lg shadow-lg text-center">
        <p id="messageText" class="text-gray-800 mb-4"></p>
        <button onclick="closeMessage()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">OK</button>
      </div>
    </div>

    <!-- Departure Form -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Registro de Salida de Patrulla</h2>
      <form id="departureForm" class="space-y-4">
        <!-- Campos de salida -->
        <!-- ... (igual que antes) ... -->
      </form>
    </div>

    <!-- Return Form -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Registro de Regreso de Patrulla</h2>
      <form id="returnForm" class="space-y-4">
        <!-- Campos de regreso -->
      </form>
    </div>
  </div>

  <script>
    // Variables globales
    let depData = null;
    let returnData = null;
    let compCount = 0;
    const MAX_COMP = 5;

    // Funciones de modal
    function showMessage(msg) {
      document.getElementById('messageText').textContent = msg;
      document.getElementById('messageBox').classList.add('active');
    }
    function closeMessage() {
      document.getElementById('messageBox').classList.remove('active');
    }

    // Generar PDF de Salida (incluye acompañantes)
    function genDepPDF(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'mm',format:'a4'});
      let y = 20;
      doc.setFontSize(14).text('REPORTE DE SALIDA - OS9', 105, y, {align:'center'});
      y += 10;
      doc.setFontSize(10);
      doc.text(`Sección: ${data.seccion}`, 15, y); y += 6;
      doc.text(`Patente: ${data.patente}`, 15, y); y += 6;
      doc.text(`Fecha/Hora Salida: ${data.fecha}`, 15, y); y += 6;
      doc.text(`Km Salida: ${data.km}`, 15, y); y += 10;

      // Jefe de Patrulla
      doc.text(`Jefe: ${data.jefe}`, 15, y); y += 6;
      doc.text(`Teléfono: ${data.telefono}`, 15, y); y += 10;
      doc.text('Equipo Jefe:', 15, y); y += 6;
      const eq = data.equipo;
      ['calzo', 'armamento', 'chaleco', 'casco', 'portatil', 'camCorporal'].forEach(key => {
        doc.text(`${key.charAt(0).toUpperCase() + key.slice(1)}: ${eq[key]}`, 20, y);
        y += 6;
      });
      y += 6;

      // Acompañantes
      if (data.acom && data.acom.length > 0) {
        doc.text('Acompañantes:', 15, y); y += 6;
        data.acom.forEach((ac, idx) => {
          doc.text(`${idx + 1}. ${ac.nombre}`, 20, y); y += 6;
          const acEq = ac.equipo;
          ['calzo', 'armamento', 'chaleco', 'casco', 'portatil', 'camCorporal'].forEach(key => {
            doc.text(`   ${key.charAt(0).toUpperCase() + key.slice(1)}: ${acEq[key]}`, 25, y);
            y += 6;
          });
          y += 4;
        });
      }

      doc.save(`Salida_OS9_${data.patente}_${data.fecha.replace(/[/,: ]/g,'-')}.pdf`);
    }

    // Generar PDF de Regreso (igual que antes)
    function genRetPDF(dep, ret) {
      // ... misma lógica que tenías para retorno, incluyendo acompañantes ...
    }

    // Controladores de formulario para llamar a genDepPDF con data.acom
    // ... aquí va tu código de recolección de datos y envío de PDF ...
  </script>
</body>
</html>
